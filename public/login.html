<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>로그인 및 회원가입</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB"
      crossorigin="anonymous"
    />
    <link href="main.css" rel="stylesheet" />
  </head>
  <body>
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <a class="navbar-brand" href="index.html">캠퍼스 마캣</a>
        <button
          class="navbar-toggler"
          type="button"
          data-bs-toggle="collapse"
          data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent"
          aria-expanded="false"
          aria-label="Toggle navigation"
        >
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarSupportedContent">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item">
              <a class="nav-link active" aria-current="page" href="index.html">Home</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="#">Link</a>
            </li>
            <li class="nav-item dropdown">
              <a
                class="nav-link dropdown-toggle"
                href="#"
                role="button"
                data-bs-toggle="dropdown"
                aria-expanded="false"
              >
                Dropdown
              </a>
              <ul class="dropdown-menu">
                <li><a class="dropdown-item" href="#">Action</a></li>
                <li><a class="dropdown-item" href="#">Another action</a></li>
                <li><hr class="dropdown-divider" /></li>
                <li>
                  <a class="dropdown-item" href="#">Something else here</a>
                </li>
              </ul>
            </li>
            <li class="nav-item">
              <a class="nav-link disabled" aria-disabled="true">Disabled</a>
            </li>
          </ul>
          <form class="d-flex" role="search">
            <input
              class="form-control me-2"
              type="search"
              placeholder="Search"
              aria-label="Search"
            />
            <button class="btn btn-outline-success" type="submit">
              Search
            </button>
          </form>
        </div>
      </div>
    </nav>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>
    <script
      src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"
      integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI"
      crossorigin="anonymous"
    ></script>
    <script
      src="https://code.jquery.com/jquery-3.7.1.min.js"
      integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo="
      crossorigin="anonymous"
    ></script>
    <script>
      const firebaseConfig = {
        apiKey: "AIzaSyAjdtCBu54lACqJ2BaSmQWTNJYuYGho4O8",
        authDomain: "campus-market-c68dd.firebaseapp.com",
        projectId: "campus-market-c68dd",
        storageBucket: "campus-market-c68dd.firebasestorage.app",
        messagingSenderId: "470548217819",
        appId: "1:470548217819:web:59a99f7ebb9e53ecf331fe",
        measurementId: "G-0BKMHYKQVK",
      };

      // Initialize Firebase
      if (!firebase.apps.length) {
        firebase.initializeApp(firebaseConfig);
      }
    </script>
    <div class="container mt-3">
      <div class="mb-3">
        <input
          type="text"
          class="form-control"
          placeholder="name"
          id="name-new"
        />
      </div>
      <div class="mb-3">
        <input
          type="email"
          class="form-control"
          placeholder="email"
          id="email-new"
        />
      </div>
      <div class="mb-3">
        <input
          type="password"
          class="form-control"
          placeholder="pw"
          id="pw-new"
        />
      </div>
      <button type="submit" class="btn btn-primary" id="register">
        가입하기
      </button>
    </div>

    <div class="container mt-3">
      <div class="mb-3">
        <input type="email" class="form-control" placeholder="email" id="email">
      </div>
      <div class="mb-3">
        <input type="password" class="form-control" placeholder="pw" id="pw">
      </div>
      <button type="submit" class="btn btn-primary" id="login">로그인하기</button>
      <button type="submit" class="btn btn-primary" id="logout">로그아웃</button>
    </div>

    <script>
      const db = firebase.firestore();
      const storage = firebase.storage(); 

      // 1. 유저 정보 확인 (에러 방지 추가)
      var 뺀거 = localStorage.getItem('user');
      if (뺀거) {
        var userJson = JSON.parse(뺀거);
        if(userJson) {
            $('#userName').html(userJson.displayName);
        }
      }

      firebase.auth().onAuthStateChanged((user) => {
        if (user) {
          // 1. 로그인 된 상태
          console.log("로그인 감지됨:", user.displayName);
          localStorage.setItem('user', JSON.stringify(user));

          var 닉네임 = user.displayName || '회원'; 
          $('#userName').html(닉네임 + '님 환영합니다');
          
          $('#login').hide();
          $('#logout').show();
          $('#register').hide(); 

        } else {
          // 2. 로그아웃 된 상태
          $('#userName').html('로그인 해주세요');
          
          $('#login').show();
          $('#logout').hide();
          $('#register').show();
        }
      });

      $('#logout').click(function(){
        firebase.auth().signOut();
        localStorage.removeItem('user');
        window.location.reload(); 
      });

      $("#login").click(function() {
        var 이메일 = $("#email").val();
        var 패스워드 = $("#pw").val();

        firebase.auth().signInWithEmailAndPassword(이메일, 패스워드).then((result) => {
            console.log(result.user);
            alert("로그인 되었습니다!");
            window.location.href = 'index.html';
          })
          .catch((error) => {
            console.log(error);
            alert("로그인 실패: " + error.message);
          });
      });

      $("#register").click(function () {
        var 이메일 = $("#email-new").val();
        var 패스워드 = $("#pw-new").val();
        var 이름 = $("#name-new").val();
        
        // 유효성 검사 (빈칸 방지)
        if (!이메일 || !패스워드) {
            alert("이메일과 비밀번호를 입력해주세요.");
            return;
        }

        firebase
          .auth()
          .createUserWithEmailAndPassword(이메일, 패스워드)
          .then((result) => {
            console.log("가입 성공", result.user);
            
            
            var 유저정보 = {
              name : 이름,
              email : 이메일
            }
            
            // 유저 정보 저장
            db.collection('user').doc(result.user.uid).set(유저정보)
              .then(() => {
                  console.log('DB 저장 성공');
              })
              .catch((err) => {
                  console.log('DB 저장 실패', err);
              });

            // 이름 저장 후 알림
            result.user.updateProfile({ displayName: 이름 })
            .then(() => {
                alert(이름 + "님 가입을 축하합니다!");
                $("#email-new").val('');
                $("#pw-new").val('');
                $("#name-new").val('');
            });
          })
          .catch((error) => {
             console.log(error);
             if (error.code === 'auth/email-already-in-use') {
                 alert("이미 가입된 이메일입니다.");
             } else if (error.code === 'auth/weak-password') {
                 alert("비밀번호는 6자리 이상이어야 합니다.");
             } else {
                 alert("가입 실패: " + error.message);
             }
          });
      });
    </script>
  </body>
</html>